<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyWallet3 - Despesas</title>
    <script src="libs/tailwindcss.js"></script>
    <script src="libs/vue.global.js"></script>
    <script src="libs/lucide.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        span.icon-wrapper { display: inline-flex; align-items: center; }
        .modal-overlay { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
        
        /* Estilo do Círculo de Data */
        .date-circle {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fee2e2;
            color: #b91c1c;
            border-radius: 9999px;
            font-weight: 800;
            font-size: 13px;
            border: 1px solid #fecaca;
            flex-shrink: 0;
        }

        input:focus, select:focus { border-color: #ef4444 !important; outline: none; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2); }
        
        /* Ajuste de scroll */
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="p-6">

    <div id="app" class="max-w-6xl mx-auto">
        
        <!-- Formulário de Lançamento -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-8">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-gray-800">
                <span class="text-red-500 icon-wrapper" v-html="getIcon('plus-circle')"></span>
                Novo Lançamento
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
                <div class="md:col-span-2">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">Descrição</label>
                    <input type="text" v-model="form.description" placeholder="O que você comprou?" 
                        class="w-full p-3 bg-gray-50 rounded-xl border border-transparent transition-all">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">Valor Total</label>
                    <input type="number" v-model="form.amount" placeholder="0,00" 
                        class="w-full p-3 bg-gray-50 rounded-xl border border-transparent transition-all">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">Data da Compra</label>
                    <input type="date" v-model="form.date" 
                        class="w-full p-3 bg-gray-50 rounded-xl border border-transparent transition-all">
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">Conta / Cartão</label>
                    <select v-model="form.accountId" class="w-full p-3 bg-gray-50 rounded-xl border border-transparent transition-all">
                        <option value="">Selecione...</option>
                        <option v-for="c in contas" :key="c.id" :value="c.id">{{ c.name }}</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">Grupo Pai</label>
                    <select v-model="form.categoryId" @change="aoMudarCategoria" class="w-full p-3 bg-gray-50 rounded-xl border border-transparent transition-all">
                        <option value="">Selecione...</option>
                        <option v-for="cat in categorias" :key="cat.id" :value="cat.id">{{ cat.name }}</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">Subgrupo</label>
                    <select v-model="form.subgroup" :disabled="!subgruposDisponiveis.length" class="w-full p-3 bg-gray-50 rounded-xl border border-transparent transition-all">
                        <option value="">Opcional</option>
                        <option v-for="s in subgruposDisponiveis" :key="s" :value="s">{{ s }}</option>
                    </select>
                </div>

                <!-- Lógica de Crédito/Parcelas -->
                <div class="flex items-center gap-4 px-2 bg-red-50 rounded-xl border border-red-100 py-2">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" v-model="form.isCredit" id="isCredit" class="w-4 h-4 accent-red-600 cursor-pointer">
                        <label for="isCredit" class="text-xs font-bold text-red-700 cursor-pointer">Compra no Crédito?</label>
                    </div>
                </div>

                <div v-if="form.isCredit" class="md:col-span-2 grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-xl border border-dashed border-gray-300">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Nº Parcelas</label>
                        <input type="number" v-model="form.numParcelas" min="1" class="w-full p-2 bg-white rounded-lg border">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">1º Vencimento</label>
                        <input type="date" v-model="form.dueDate" class="w-full p-2 bg-white rounded-lg border">
                    </div>
                </div>

                <div class="md:col-span-4 flex justify-end gap-3 mt-2">
                    <button @click="salvarDespesa" :disabled="loading" 
                        class="px-8 py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition shadow-lg shadow-red-100 disabled:opacity-50">
                        {{ loading ? 'Salvando...' : 'Lançar Transação' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Histórico Agrupado -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-4 bg-gray-800 border-b flex flex-wrap justify-between items-center gap-4">
                <div class="flex items-center gap-2 text-white">
                    <span class="icon-wrapper" v-html="getIcon('list', 18)"></span>
                    <h3 class="font-bold">Histórico de Despesas</h3>
                </div>
                
                <div class="flex items-center gap-4">
                    <!-- Total Geral -->
                    <div class="text-right">
                        <p class="text-[9px] uppercase font-bold text-gray-400 leading-none">Total do Mês</p>
                        <p class="text-xl font-black text-white">{{ formatarMoeda(totalGeralMes) }}</p>
                    </div>

                    <!-- Navegação Meses -->
                    <div class="flex items-center gap-2 bg-white p-1 rounded-xl shadow-inner border border-gray-700">
                        <button @click="mudarMes(-1)" class="p-1.5 hover:bg-gray-100 rounded-lg text-gray-600"> 
                            <span class="icon-wrapper" v-html="getIcon('chevron-left', 18)"></span> 
                        </button>
                        <span class="font-bold text-[10px] text-blue-600 min-w-[110px] text-center uppercase tracking-widest">
                            {{ nomeMes(filtroData.mes) }} {{ filtroData.ano }}
                        </span>
                        <button @click="mudarMes(1)" class="p-1.5 hover:bg-gray-100 rounded-lg text-gray-600"> 
                            <span class="icon-wrapper" v-html="getIcon('chevron-right', 18)"></span> 
                        </button>
                    </div>
                </div>
            </div>

            <div class="max-h-[600px] overflow-y-auto custom-scroll">
                <table class="w-full text-left border-collapse">
                    <tbody v-for="grupo in despesasAgrupadas" :key="grupo.nome">
                        <!-- Cabeçalho da Categoria -->
                        <tr class="bg-gray-50/80 border-y border-gray-100">
                            <td colspan="3" class="p-3 pl-6">
                                <span class="font-black text-gray-700 uppercase tracking-widest text-[11px]">{{ grupo.nome }}</span>
                            </td>
                            <td class="p-3 text-right">
                                <span class="text-[10px] font-bold text-gray-400 uppercase mr-2">Subtotal:</span>
                                <span class="font-bold text-gray-800">{{ formatarMoeda(grupo.total) }}</span>
                            </td>
                            <td></td>
                        </tr>

                        <!-- Itens -->
                        <tr v-for="item in grupo.itens" :key="item.id" class="border-b border-gray-50 last:border-0 hover:bg-blue-50/20 transition group">
                            <td class="p-4 w-16">
                                <div class="date-circle">{{ obterDia(item.date) }}</div>
                            </td>
                            <td class="p-4">
                                <div class="font-bold text-gray-800 text-sm">{{ item.description }}</div>
                                <div class="flex items-center gap-2 mt-1">
                                    <span v-if="item.is_installment" class="text-[9px] bg-blue-100 text-blue-600 px-1 rounded-sm font-bold">
                                        {{item.installment_number}}/{{item.installment_total}}
                                    </span>
                                    <span class="text-[10px] text-gray-400 flex items-center gap-1">
                                        <span class="icon-wrapper" v-html="getIcon('wallet', 10)"></span>
                                        {{ item.account_name }}
                                    </span>
                                </div>
                            </td>
                            <td class="p-4">
                                <div v-if="item.subgroup" class="text-[10px] font-medium text-gray-500 italic">
                                    {{ item.subgroup }}
                                </div>
                            </td>
                            <td class="p-4 text-right">
                                <span class="font-black text-red-600 text-sm">{{ formatarMoeda(item.amount) }}</span>
                            </td>
                            <td class="p-4 text-center w-24">
                                <div class="flex justify-center gap-2 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button @click="abrirEdicao(item)" class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg" title="Editar">
                                        <span class="icon-wrapper" v-html="getIcon('edit-3', 14)"></span>
                                    </button>
                                    <button @click="deletarItem(item)" class="p-2 text-red-500 hover:bg-red-100 rounded-lg" title="Excluir">
                                        <span class="icon-wrapper" v-html="getIcon('trash-2', 14)"></span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                    <tbody v-if="despesasAgrupadas.length === 0">
                        <tr>
                            <td colspan="5" class="p-20 text-center text-gray-400 italic">Nenhum lançamento encontrado para este mês.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal de Edição -->
        <div v-if="modalEdicao.aberto" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl">
                <h3 class="text-lg font-bold mb-6 text-gray-800 border-b pb-4">Ajustar Lançamento</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">Descrição</label>
                        <input type="text" v-model="modalEdicao.form.description" class="w-full p-3 bg-gray-50 rounded-xl border">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">Valor</label>
                        <input type="number" v-model="modalEdicao.form.amount" class="w-full p-3 bg-gray-50 rounded-xl border">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">Data</label>
                        <input type="date" v-model="modalEdicao.form.date" class="w-full p-3 bg-gray-50 rounded-xl border">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">Conta</label>
                        <select v-model="modalEdicao.form.account_id" class="w-full p-3 bg-gray-50 rounded-xl border">
                            <option v-for="c in contas" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-4 mt-8">
                    <button @click="modalEdicao.aberto = false" class="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition">Cancelar</button>
                    <button @click="confirmarEdicao" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-100">Salvar</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, onMounted, computed, watch } = Vue;

        createApp({
            setup() {
                const form = ref({ 
                    description: '', amount: '', 
                    date: new Date().toISOString().split('T')[0], 
                    dueDate: new Date().toISOString().split('T')[0], 
                    accountId: '', categoryId: '', subgroup: '', 
                    isCredit: false, numParcelas: 1 
                });

                const contas = ref([]);
                const categorias = ref([]);
                const historico = ref([]);
                const loading = ref(false);
                const filtroData = ref({ mes: new Date().getMonth() + 1, ano: new Date().getFullYear() });
                const modalEdicao = ref({ aberto: false, form: {} });

                const getIcon = (name, size = 18) => `<i data-lucide="${name}" style="width:${size}px;height:${size}px"></i>`;
                const formatarMoeda = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
                
                const obterDia = (d) => {
                    if (!d) return '00';
                    return d.includes('-') ? d.split('-')[2] : d.split('/')[0];
                };

                const nomeMes = (m) => ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][m-1];

                const carregarConfigs = async () => {
                    const rContas = await fetch('http://localhost:3000/api/configuracoes?type=Conta');
                    contas.value = await rContas.json();
                    const rCats = await fetch('http://localhost:3000/api/configuracoes?type=GrupoDespesa');
                    categorias.value = await rCats.json();
                };

                const carregarHistorico = async () => {
                    const res = await fetch('http://localhost:3000/api/despesas');
                    historico.value = await res.json();
                    setTimeout(() => lucide.createIcons(), 50);
                };

                // Subgrupos Disponíveis
                const subgruposDisponiveis = computed(() => {
                    if (!form.value.categoryId) return [];
                    const c = categorias.value.find(cat => cat.id == form.value.categoryId);
                    if (!c || !c.subgroups) return [];
                    try {
                        let list = typeof c.subgroups === 'string' ? JSON.parse(c.subgroups) : c.subgroups;
                        if (!Array.isArray(list)) return [];
                        
                        return list.map(item => {
                            const nameValue = (typeof item === 'object' && item !== null) ? item.name : item;
                            return String(nameValue).replace(/[\[\]\"\' ]/g, '').trim();
                        });
                    } catch(e) { return []; }
                });

                // Agrupamento de Histórico por Categoria
                const despesasAgrupadas = computed(() => {
                    const grupos = {};
                    const filtrado = historico.value.filter(item => {
                        const [y, m] = item.date.split('-');
                        return parseInt(y) === filtroData.value.ano && parseInt(m) === filtroData.value.mes;
                    });

                    filtrado.forEach(item => {
                        const cat = item.category_name || 'Diversos';
                        if (!grupos[cat]) grupos[cat] = { nome: cat, itens: [], total: 0 };
                        grupos[cat].itens.push(item);
                        grupos[cat].total += parseFloat(item.amount);
                    });

                    return Object.values(grupos).sort((a,b) => b.total - a.total).map(g => {
                        g.itens.sort((a,b) => obterDia(b.date) - obterDia(a.date));
                        return g;
                    });
                });

                const totalGeralMes = computed(() => {
                    return despesasAgrupadas.value.reduce((acc, g) => acc + g.total, 0);
                });

                watch([filtroData, despesasAgrupadas], () => setTimeout(() => lucide.createIcons(), 50));

                const salvarDespesa = async () => {
                    if(!form.value.description || !form.value.amount || !form.value.accountId || !form.value.categoryId) {
                        alert("Por favor, preencha todos os campos obrigatórios.");
                        return;
                    }
                    loading.value = true;
                    try {
                        // ADIÇÃO CRÍTICA: Enviamos a Data da Compra separada da Data de Vencimento
                        const payload = { 
                            ...form.value, 
                            date: form.value.isCredit ? form.value.dueDate : form.value.date, 
                            purchaseDate: form.value.date, // <--- Aqui está o segredo para o novo gráfico
                            isInstallment: form.value.isCredit 
                        };
                        
                        const res = await fetch('http://localhost:3000/api/despesas', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (res.ok) { 
                            const d = form.value.date; const dd = form.value.dueDate;
                            form.value = { 
                                description: '', amount: '', date: d, dueDate: dd, 
                                accountId: '', categoryId: '', subgroup: '', isCredit: false, numParcelas: 1 
                            };
                            await carregarHistorico(); 
                        }
                    } finally { loading.value = false; }
                };

                const abrirEdicao = (item) => { 
                    modalEdicao.value.form = { ...item }; 
                    modalEdicao.value.aberto = true; 
                    setTimeout(() => lucide.createIcons(), 50);
                };
                
                const confirmarEdicao = async () => {
                    const f = modalEdicao.value.form;
                    const res = await fetch(`http://localhost:3000/api/despesas/${f.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...f, accountId: f.account_id, categoryId: f.category_id })
                    });
                    if (res.ok) { modalEdicao.value.aberto = false; await carregarHistorico(); }
                };

                const deletarItem = async (item) => {
                    let msg = "Excluir lançamento?";
                    if (item.is_installment) msg = "Deseja excluir TODAS as parcelas deste grupo de crédito?";
                    if (!confirm(msg)) return;
                    
                    const url = `http://localhost:3000/api/despesas/${item.id}${item.is_installment ? '?groupId='+item.installment_group_id : ''}`;
                    await fetch(url, { method: 'DELETE' });
                    await carregarHistorico();
                };

                const mudarMes = (diff) => {
                    let nm = filtroData.value.mes + diff;
                    let na = filtroData.value.ano;
                    if (nm > 12) { nm = 1; na++; }
                    else if (nm < 1) { nm = 12; na--; }
                    filtroData.value.mes = nm;
                    filtroData.value.ano = na;
                };

                const aoMudarCategoria = () => {
                    form.value.subgroup = '';
                };

                onMounted(() => { carregarConfigs(); carregarHistorico(); });

                return {
                    form, contas, categorias, loading, filtroData, despesasAgrupadas, totalGeralMes,
                    subgruposDisponiveis, mudarMes, salvarDespesa, deletarItem, getIcon, formatarMoeda, 
                    obterDia, nomeMes, modalEdicao, abrirEdicao, confirmarEdicao, aoMudarCategoria
                };
            }
        }).mount('#app');
    </script>
</body>
</html>